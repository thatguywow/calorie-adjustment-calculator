<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Calorie Adjustment Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Reset */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: #2d2d2d;  /* Solid charcoal background */
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        .container {
            background: #1f1f1f;  /* Darker charcoal container */
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 640px;
            overflow: hidden;
            margin: 20px 0;
            border: 1px solid #3a3a3a;
        }
        
        /* Header */
        .logo-header {
            background: #252525;  /* Slightly lighter charcoal */
            padding: 30px 20px 20px;
            text-align: center;
            border-bottom: 1px solid #3a3a3a;
            position: relative;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: #63b3ed;  /* Blue accent */
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
        }
        
        .logo-subtitle {
            color: #a0aec0;
            font-size: 0.95rem;
            max-width: 85%;
            margin: 0 auto;
            line-height: 1.6;
            font-weight: 400;
            position: relative;
            z-index: 2;
        }
        
        /* Tab bar */
        .tab-bar {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-top: 20px;
            z-index: 60;
            position: relative;
            background: #2d2d2d;
            padding: 4px;
            border-radius: 10px;
        }
        
        .tab-btn {
            background: transparent;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            color: #a0aec0;
            font-weight: 500;
            transition: all .15s;
            position: relative;
            z-index: 61;
            flex: 1;
            max-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn.active {
            background: #3a3a3a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            color: #63b3ed;
            font-weight: 600;
        }
        
        .content {
            padding: 30px;
        }
        
        /* Info box */
        .info-box {
            background: #252525;
            border-radius: 12px;
            margin-bottom: 25px;
            overflow: hidden;
            border-left: 3px solid #63b3ed;
        }
        
        details.info-box {
            border-radius: 12px;
            overflow: hidden;
            background: transparent;
        }
        
        details.info-box summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #252525;
        }
        
        details.info-box summary h3 {
            margin: 0;
            color: #63b3ed;
            font-size: 1.05rem;
            font-weight: 600;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        details.info-box summary .chev {
            transition: transform .18s ease;
            color: #63b3ed;
            font-size: 0.95rem;
            margin-left: 8px;
        }
        
        details.info-box[open] summary .chev {
            transform: rotate(180deg);
        }
        
        .info-content {
            padding: 16px 20px;
            background: #1f1f1f;
        }
        
        .info-box h3 {
            color: #63b3ed;
            margin-bottom: 12px;
            font-size: 1.15rem;
            font-weight: 600;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .info-box p, .info-box ul {
            margin-bottom: 12px;
            color: #cbd5e0;
            line-height: 1.7;
            font-size: 0.95rem;
        }
        
        .info-box ul {
            padding-left: 20px;
        }
        
        .info-box ul li {
            margin-bottom: 8px;
        }
        
        /* Form and calculator styles */
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #e2e8f0;
            font-size: 0.95rem;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        select, input {
            width: 100%;
            padding: 14px;
            border: 1px solid #3a3a3a;
            border-radius: 10px;
            font-size: 1rem;
            background: #252525;
            transition: all .2s;
            color: #e2e8f0;
        }
        
        select:focus, input:focus {
            border-color: #63b3ed;
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.2);
        }
        
        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }
        
        button {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }
        
        #calculateBtn {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
        }
        
        #resetBtn {
            background: #252525;
            color: #a0aec0;
            border: 1px solid #3a3a3a;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .results {
            background: #252525;
            border-radius: 12px;
            padding: 24px;
            margin-top: 30px;
            display: none;
            border: 1px solid #3a3a3a;
        }
        
        .results h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #63b3ed;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 14px 16px;
            border-radius: 10px;
            background: #1f1f1f;
            transition: transform .2s;
            border: 1px solid #3a3a3a;
        }
        
        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background: #252525;
        }
        
        .result-label {
            font-weight: 500;
            color: #cbd5e0;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .result-value {
            font-weight: 600;
            text-align: right;
            font-size: 1.05rem;
            color: #e2e8f0;
        }
        
        .positive { 
            color: #68d391; 
        } 
        
        .negative { 
            color: #fc8181; 
        }
        
        .action-box {
            padding: 16px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-weight: 500;
            font-size: 1rem;
            display: none;
        }
        
        .increase-action {
            background: rgba(72, 187, 120, 0.15);
            color: #68d391;
            border: 1px solid rgba(72, 187, 120, 0.3);
        }
        
        .decrease-action {
            background: rgba(248, 113, 113, 0.15);
            color: #fc8181;
            border: 1px solid rgba(248, 113, 113, 0.3);
        }
        
        .maintenance-rate {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .maintenance-rate input {
            width: 130px;
            padding: 10px;
            border-radius: 10px;
            background: #252525;
            border: 1px solid #3a3a3a;
            color: #e2e8f0;
        }
        
        .maintenance-desc {
            margin-top: 15px;
            text-align: center;
            color: #a0aec0;
            font-size: 0.9rem;
        }
        
        .calorie-disclaimer {
            margin-top: 20px;
            font-size: 0.85rem;
            color: #fc8181;
            background: rgba(248, 113, 113, 0.15);
            border-left: 3px solid #fc8181;
            padding: 12px 15px;
            border-radius: 8px;
            line-height: 1.5;
            display: none;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #a0aec0;
            font-size: 0.85rem;
            border-top: 1px solid #3a3a3a;
            background-color: #1f1f1f;
        }
        
        /* Weight log specific styles */
        .weight-log {
            background: #252525;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #3a3a3a;
        }
        
        .weight-log h3 {
            color: #63b3ed;
            margin-bottom: 12px;
        }
        
        .log-list {
            margin-top: 12px;
            display: grid;
            gap: 8px;
            max-height: 320px;
            overflow: auto;
        }
        
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #1f1f1f;
            border-radius: 10px;
            border: 1px solid #3a3a3a;
        }
        
        .log-item small {
            color: #a0aec0;
        }
        
        /* median buttons */
        .median-btn {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: #fff;
            padding: 12px 14px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            min-width: 48%;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .median-btn:hover {
            background: linear-gradient(135deg, #3182ce, #2b6cb0);
        }
        
        .small-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #e2e8f0;
            background: #252525;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .small-btn.delete {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: #fff;
        }
        
        .medians-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* alignment for medians rows */
        .weight-log .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            background: transparent;
            border: none;
        }
        
        .weight-log .result-item .result-label {
            flex: 1 1 auto;
            color: #cbd5e0;
            font-weight: 500;
        }
        
        .weight-log .result-item .result-value {
            flex: 0 0 auto;
            margin-left: 20px;
            text-align: right;
            font-weight: 600;
            font-size: 1.05rem;
            color: #e2e8f0;
        }
        
        @media (max-width: 480px) {
            body { padding: 15px; }
            .logo { font-size: 1.6rem; }
            .content { padding: 20px 15px; }
            .medians-row { flex-direction: column; }
            .median-btn { min-width: 100%; }
            .buttons { grid-template-columns: 1fr; }
            .tab-btn { font-size: 0.9rem; padding: 8px 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-header">
            <div class="logo">Calorie Adjustment Calculator</div>
            <p class="logo-subtitle">Precisely adjust your calorie intake based on weekly weight trends</p>

            <div class="tab-bar" role="tablist" aria-label="Main tabs">
                <button id="tabCalculator" class="tab-btn active" role="tab" aria-selected="true" type="button">
                    <i class="fas fa-calculator"></i> Calculator
                </button>
                <button id="tabWeightLog" class="tab-btn" role="tab" aria-selected="false" type="button">
                    <i class="fas fa-list"></i> Log
                </button>
                <button id="tabInfo" class="tab-btn" role="tab" aria-selected="false" type="button">
                    <i class="fas fa-info-circle"></i> Info
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Calculator tab -->
            <div id="calculatorTab">
                <div class="form-group">
                    <label for="goal"><i class="fas fa-bullseye"></i> Goal Type:</label>
                    <select id="goal" onchange="toggleGoalField()" required>
                        <option value="" disabled selected>Select your goal</option>
                        <option value="loss">Weight Loss</option>
                        <option value="gain">Weight Gain</option>
                        <option value="maintenance">Weight Maintenance</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="prev_weight"><i class="fas fa-weight-scale"></i> Previous Weekly Median Weight (kg):</label>
                    <input type="number" step="0.1" id="prev_weight" placeholder="e.g., 75.5">
                </div>

                <div class="form-group">
                    <label for="curr_weight"><i class="fas fa-weight-scale"></i> Current Weekly Median Weight (kg):</label>
                    <input type="number" step="0.1" id="curr_weight" placeholder="e.g., 74.8">
                </div>

                <div class="form-group goal-field" id="goalField">
                    <label for="weekly_goal"><i class="fas fa-tachometer-alt"></i> Weekly Goal Amount (kg/week):</label>
                    <input type="number" step="0.1" id="weekly_goal" placeholder="e.g., 0.5 (for loss/gain)">
                </div>

                <div class="form-group">
                    <label for="calories"><i class="fas fa-fire"></i> Current Daily Calories:</label>
                    <input type="number" id="calories" placeholder="e.g., 2000">
                </div>

                <div class="buttons">
                    <button id="calculateBtn" type="button"><i class="fas fa-calculator"></i> Calculate Adjustment</button>
                    <button id="resetBtn" type="button"><i class="fas fa-redo"></i> Reset Form</button>
                </div>

                <div class="results" id="resultsSection">
                    <h2><i class="fas fa-chart-line"></i> Your Calorie Adjustment</h2>

                    <div class="result-grid">
                        <div class="result-item">
                            <span class="result-label"><i class="fas fa-exchange-alt"></i> Daily Adjustment Needed:</span>
                            <span class="result-value" id="adjustment">-</span>
                        </div>

                        <div class="result-item">
                            <span class="result-label"><i class="fas fa-burn"></i> Current Calories:</span>
                            <span class="result-value" id="current_calories">-</span>
                        </div>

                        <div class="result-item">
                            <span class="result-label"><i class="fas fa-bullseye"></i> New Calorie Target:</span>
                            <span class="result-value" id="new_calories">-</span>
                        </div>
                    </div>

                    <div id="maintenanceRateSection" style="display:none;">
                        <div class="maintenance-desc" id="maintenanceRateDesc"></div>
                        <div class="maintenance-rate">
                            <label for="maintenance_rate_input">Weekly rate (kg/week):</label>
                            <input type="number" step="0.05" id="maintenance_rate_input" />
                            <button id="applyRateBtn" type="button">Apply Rate</button>
                        </div>
                    </div>

                    <div id="calorieDisclaimer" class="calorie-disclaimer" role="status" aria-live="polite">
                        <i class="fas fa-exclamation-triangle"></i>
                        Suggested daily calories are below the commonly recommended minimum (1200 kcal/day). Consider choosing a smaller weekly rate or consult a healthcare professional before making large changes.
                    </div>

                    <div class="action-box" id="actionBox">
                        <span id="actionText"></span>
                    </div>
                </div>
            </div>

            <!-- Weight Log tab -->
            <div id="weightLogTab" style="display:none;">
                <div class="weight-log">
                    <h3><i class="fas fa-list-alt"></i> Weekly Weight Log</h3>

                    <div class="form-group">
                        <label for="log_date">Date:</label>
                        <input type="date" id="log_date">
                    </div>

                    <div class="form-group">
                        <label for="log_weight">Weight (kg):</label>
                        <input type="number" step="0.1" id="log_weight" placeholder="e.g., 75.2">
                    </div>

                    <div class="buttons">
                        <button id="addLogBtn" type="button"><i class="fas fa-plus"></i> Add / Update Entry</button>
                        <button id="clearWeekBtn" type="button" style="background: linear-gradient(135deg, #e53e3e, #c53030); color:white;"><i class="fas fa-trash"></i> Clear This Week</button>
                    </div>

                    <div style="margin-top:16px">
                        <div class="result-item" style="background:transparent; border:none;">
                            <span class="result-label">Current Week Median:</span>
                            <span class="result-value" id="currentWeekMedian">-</span>
                        </div>
                        <div class="result-item" style="background:transparent; border:none;">
                            <span class="result-label">Previous Week Median:</span>
                            <span class="result-value" id="previousWeekMedian">-</span>
                        </div>

                        <div class="medians-row">
                            <button class="median-btn" id="copyCurrToCalc" type="button">
                                <i class="fas fa-copy"></i> Use current median
                            </button>
                            <button class="median-btn" id="copyPrevToCalc" type="button">
                                <i class="fas fa-copy"></i> Use previous median
                            </button>
                        </div>
                    </div>

                    <div class="log-list" id="logList"></div>
                </div>
            </div>

            <!-- New Info tab -->
            <div id="infoTab" style="display:none;">
                <details class="info-box" id="infoBoxCalculator">
                    <summary>
                        <h3><i class="fas fa-calculator"></i> How to Use the Calculator</h3>
                        <span class="chev"><i class="fas fa-chevron-down"></i></span>
                    </summary>
                    <div class="info-content">
                        <div class="info-inner">
                            <p>This tool helps you adjust your daily calorie intake based on your actual weight change compared to your goal. Here's how to use it:</p>

                            <h3><i class="fas fa-weight-scale"></i> Calculating Weekly Median Weight</h3>
                            <ul>
                                <li>Weigh yourself at the same time each day for a week</li>
                                <li>Record all 7 weights (e.g. 75.2, 75.0, 74.8, 75.1, 75.3, 74.9, 75.0)</li>
                                <li>Sort the weights from lowest to highest</li>
                                <li>The median is the middle value (4th value in this example: 75.0 kg)</li>
                            </ul>

                            <h3><i class="fas fa-chart-line"></i> Using the Calculator</h3>
                            <ul>
                                <li>Select your goal type (weight loss, gain, or maintenance)</li>
                                <li>Enter your previous and current weekly median weights</li>
                                <li>Set your weekly goal amount (for loss/gain)</li>
                                <li>Enter your current daily calorie intake</li>
                                <li>Click "Calculate Adjustment" to get your new calorie target</li>
                            </ul>

                            <h3><i class="fas fa-lightbulb"></i> Why Use Medians?</h3>
                            <p>By comparing weekly median weights, you eliminate daily fluctuations and get a true picture of your weight trend. This gives you a more accurate basis for adjusting your calories.</p>
                        </div>
                    </div>
                </details>

                <details class="info-box" id="infoBoxWeightLog">
                    <summary>
                        <h3><i class="fas fa-list"></i> How to Use the Weight Log</h3>
                        <span class="chev"><i class="fas fa-chevron-down"></i></span>
                    </summary>
                    <div class="info-content">
                        <div class="info-inner">
                            <p>The Weight Log tab helps you track your daily weights and automatically calculates weekly medians:</p>

                            <h3><i class="fas fa-plus-circle"></i> Adding Entries</h3>
                            <ul>
                                <li>Select a date and enter your weight in kilograms</li>
                                <li>Click "Add/Update Entry" to save your weight</li>
                                <li>The system automatically groups entries by week</li>
                            </ul>

                            <h3><i class="fas fa-calculator"></i> Understanding Medians</h3>
                            <ul>
                                <li>Current Week Median shows the median of weights from the current 7-day period</li>
                                <li>Previous Week Median shows the median from the previous 7-day period</li>
                                <li>These medians update automatically as you add entries</li>
                            </ul>

                            <h3><i class="fas fa-exchange-alt"></i> Using with Calculator</h3>
                            <ul>
                                <li>Click "Use current median" to copy the current week's median to the Calculator</li>
                                <li>Click "Use previous median" to copy the previous week's median to the Calculator</li>
                            </ul>

                            <h3><i class="fas fa-trash-alt"></i> Managing Data</h3>
                            <ul>
                                <li>Delete individual entries using the "Del" button</li>
                                <li>Clear all entries for the current week with "Clear This Week"</li>
                            </ul>
                        </div>
                    </div>
                </details>
            </div>

        </div>

        <footer>
            <p>Calorie Adjustment Calculator &copy; <span id="year"></span> | Precision Nutrition Tool</p>
        </footer>
    </div>

    <script>
        /* --- Constants / DOM --- */
        const DAILY_FACTOR = 7700 / 7;
        const MIN_SAFE_CALORIES = 1200;
        const STORAGE_KEY = 'calorie_weight_weeks_v2';

        const goalSelect = document.getElementById('goal');
        const calculateBtn = document.getElementById('calculateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultsSection = document.getElementById('resultsSection');
        const adjustmentEl = document.getElementById('adjustment');
        const currentCaloriesEl = document.getElementById('current_calories');
        const newCaloriesEl = document.getElementById('new_calories');
        const actionBox = document.getElementById('actionBox');
        const actionText = document.getElementById('actionText');
        const maintenanceRateSection = document.getElementById('maintenanceRateSection');
        const maintenanceRateDesc = document.getElementById('maintenanceRateDesc');
        const maintenanceRateInput = document.getElementById('maintenance_rate_input');
        const applyRateBtn = document.getElementById('applyRateBtn');
        const calorieDisclaimer = document.getElementById('calorieDisclaimer');

        const tabCalculator = document.getElementById('tabCalculator');
        const tabWeightLog = document.getElementById('tabWeightLog');
        const tabInfo = document.getElementById('tabInfo');
        const calculatorTab = document.getElementById('calculatorTab');
        const weightLogTab = document.getElementById('weightLogTab');
        const infoTab = document.getElementById('infoTab');
        const logDateInput = document.getElementById('log_date');
        const logWeightInput = document.getElementById('log_weight');
        const addLogBtn = document.getElementById('addLogBtn');
        const clearWeekBtn = document.getElementById('clearWeekBtn');
        const logList = document.getElementById('logList');
        const currentWeekMedianEl = document.getElementById('currentWeekMedian');
        const previousWeekMedianEl = document.getElementById('previousWeekMedian');
        const copyCurrToCalcBtn = document.getElementById('copyCurrToCalc');
        const copyPrevToCalcBtn = document.getElementById('copyPrevToCalc');

        document.getElementById('year').textContent = new Date().getFullYear();

        /* --- Utility: median (true median) --- */
        function computeMedian(arr) {
            if (!arr || arr.length === 0) return null;
            const numeric = arr.map(x => Number(x)).filter(x => !isNaN(x));
            if (numeric.length === 0) return null;
            numeric.sort((a,b) => a - b);
            const mid = Math.floor(numeric.length / 2);
            if (numeric.length % 2 === 1) return numeric[mid];
            return (numeric[mid-1] + numeric[mid]) / 2;
        }

        /* --- Storage helpers --- */
        function saveStorage(obj) { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
        function loadStorage() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return { weeks: [] };
                return JSON.parse(raw);
            } catch (e) {
                return { weeks: [] };
            }
        }
        function parseYMDToUTC(dateStr) {
            if (!dateStr) return null;
            const p = dateStr.split('-').map(Number);
            if (p.length !== 3 || p.some(isNaN)) return null;
            return new Date(Date.UTC(p[0], p[1]-1, p[2]));
        }
        function formatUTCToYMD(d) {
            const y = d.getUTCFullYear();
            const m = String(d.getUTCMonth()+1).padStart(2,'0');
            const day = String(d.getUTCDate()).padStart(2,'0');
            return `${y}-${m}-${day}`;
        }
        function addDaysUTC(d, days) {
            const r = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
            r.setUTCDate(r.getUTCDate() + days);
            return r;
        }

        /* --- Calendar / week utilities --- */
        function findWeekContaining(dateStr, storage) {
            const d = parseYMDToUTC(dateStr);
            if (!d) return -1;
            const w = storage.weeks || [];
            for (let i=0;i<w.length;i++) {
                const start = parseYMDToUTC(w[i].start);
                const end = addDaysUTC(start, 6);
                if (d.getTime() >= start.getTime() && d.getTime() <= end.getTime()) return i;
            }
            return -1;
        }
        function insertWeekSorted(newWeek, storage) {
            storage.weeks = storage.weeks || [];
            storage.weeks.push(newWeek);
            storage.weeks.sort((a,b)=> a.start > b.start ? 1 : -1);
        }

        /* --- Recompute and store a week's median whenever entries change --- */
        function updateWeekMedianAndSave(storage, weekIndex) {
            if (!storage.weeks || !storage.weeks[weekIndex]) return;
            const wk = storage.weeks[weekIndex];
            const values = wk.entries ? Object.values(wk.entries).map(Number) : [];
            const med = computeMedian(values);
            wk.median = med === null ? null : Number(med);
            saveStorage(storage);
        }

        /* --- Add / update / delete entries (ensuring median stored) --- */
        function addOrUpdateEntry(dateStr, weightVal) {
            if (!dateStr) { alert('Please pick a date'); return; }
            const dt = parseYMDToUTC(dateStr);
            if (!dt) { alert('Invalid date'); return; }
            if (isNaN(weightVal)) { alert('Please enter a valid weight'); return; }

            const storage = loadStorage();
            storage.weeks = storage.weeks || [];
            const normalized = formatUTCToYMD(dt);
            const containingIdx = findWeekContaining(normalized, storage);

            if (containingIdx !== -1) {
                const wk = storage.weeks[containingIdx];
                wk.entries = wk.entries || {};
                wk.entries[normalized] = Number(weightVal);
                updateWeekMedianAndSave(storage, containingIdx);
                renderWeekData();
                return;
            }

            if (!storage.weeks || storage.weeks.length === 0) {
                const newWeek = { start: normalized, entries: {}, median: null };
                newWeek.entries[normalized] = Number(weightVal);
                updateWeekMedianAndSave({ weeks: [newWeek] }, 0);
                insertWeekSorted(newWeek, storage);
                saveStorage(storage);
                renderWeekData();
                return;
            }

            const firstStart = parseYMDToUTC(storage.weeks[0].start);
            if (dt.getTime() < firstStart.getTime()) {
                const newWeek = { start: normalized, entries: {}, median: null };
                newWeek.entries[normalized] = Number(weightVal);
                updateWeekMedianAndSave({ weeks: [newWeek] }, 0);
                insertWeekSorted(newWeek, storage);
                saveStorage(storage);
                renderWeekData();
                return;
            }

            for (let i=0;i<storage.weeks.length;i++) {
                const w = storage.weeks[i];
                const wStart = parseYMDToUTC(w.start);
                const wEnd = addDaysUTC(wStart, 6);
                if (dt.getTime() < wStart.getTime()) {
                    const prev = storage.weeks[i-1];
                    const prevEnd = addDaysUTC(parseYMDToUTC(prev.start), 6);
                    if (dt.getTime() > prevEnd.getTime()) {
                        const newWeek = { start: normalized, entries: {}, median: null };
                        newWeek.entries[normalized] = Number(weightVal);
                        updateWeekMedianAndSave({ weeks: [newWeek] }, 0);
                        insertWeekSorted(newWeek, storage);
                        saveStorage(storage);
                        renderWeekData();
                        return;
                    } else {
                        alert('This date falls into an unfinished period — it must be inside an existing week or after the previous week ended to start a new week.');
                        return;
                    }
                }
            }

            const last = storage.weeks[storage.weeks.length - 1];
            const lastEnd = addDaysUTC(parseYMDToUTC(last.start), 6);
            if (dt.getTime() > lastEnd.getTime()) {
                const newWeek = { start: normalized, entries: {}, median: null };
                newWeek.entries[normalized] = Number(weightVal);
                updateWeekMedianAndSave({ weeks: [newWeek] }, 0);
                insertWeekSorted(newWeek, storage);
                saveStorage(storage);
                renderWeekData();
                return;
            }

            alert('Could not place date into a week. Ensure it either falls into an existing week or is after the last week ended to start a new one.');
        }

        function deleteEntry(dateStr) {
            const storage = loadStorage();
            if (!storage.weeks) return;
            for (let i=0;i<storage.weeks.length;i++) {
                const wk = storage.weeks[i];
                if (wk.entries && wk.entries[dateStr] !== undefined) {
                    delete wk.entries[dateStr];
                    if (!wk.entries || Object.keys(wk.entries).length === 0) {
                        storage.weeks.splice(i,1);
                    } else {
                        updateWeekMedianAndSave(storage, i);
                    }
                    saveStorage(storage);
                    renderWeekData();
                    return;
                }
            }
        }

        /* --- Render current/previous medians and the active week's log list --- */
        function renderWeekData() {
            const storage = loadStorage();
            storage.weeks = storage.weeks || [];

            const today = (function(){ const t = new Date(); return new Date(Date.UTC(t.getFullYear(), t.getMonth(), t.getDate())); })();
            let currentWeek = null;
            let previousWeek = null;

            for (let i=0;i<storage.weeks.length;i++) {
                const w = storage.weeks[i];
                const s = parseYMDToUTC(w.start);
                const e = addDaysUTC(s, 6);
                if (today.getTime() >= s.getTime() && today.getTime() <= e.getTime()) {
                    currentWeek = { index:i, week:w };
                    if (i-1 >= 0) previousWeek = { index:i-1, week: storage.weeks[i-1] };
                    break;
                }
                if (today.getTime() > e.getTime()) {
                    previousWeek = { index:i, week:w };
                    continue;
                }
                if (today.getTime() < s.getTime()) {
                    break;
                }
            }

            if (!currentWeek && storage.weeks.length > 0) {
                const last = storage.weeks[storage.weeks.length - 1];
                const lastEnd = addDaysUTC(parseYMDToUTC(last.start), 6);
                if (today.getTime() > lastEnd.getTime()) {
                    previousWeek = { index: storage.weeks.length - 1, week: last };
                }
            }

            const currMedian = (currentWeek && currentWeek.week.median !== undefined && currentWeek.week.median !== null)
                ? Number(currentWeek.week.median)
                : (currentWeek ? computeMedian(Object.values(currentWeek.week.entries || {}).map(Number)) : null);

            const prevMedian = (previousWeek && previousWeek.week.median !== undefined && previousWeek.week.median !== null)
                ? Number(previousWeek.week.median)
                : (previousWeek ? computeMedian(Object.values(previousWeek.week.entries || {}).map(Number)) : null);

            currentWeekMedianEl.textContent = currMedian === null ? '-' : currMedian.toFixed(2) + ' kg';
            previousWeekMedianEl.textContent = prevMedian === null ? '-' : prevMedian.toFixed(2) + ' kg';

            logList.innerHTML = '';
            if (currentWeek) {
                const entriesArr = Object.entries(currentWeek.week.entries || {}).map(([d,w]) => ({ date: d, weight: Number(w) }));
                if (entriesArr.length === 0) {
                    logList.innerHTML = '<div style="color:#a0aec0">No entries for the current 7-day block yet.</div>';
                } else {
                    entriesArr.sort((a,b)=> a.date > b.date ? 1 : -1).forEach(entry => {
                        const row = document.createElement('div');
                        row.className = 'log-item';
                        row.innerHTML = `<div><strong>${entry.weight.toFixed(1)} kg</strong><br><small>${entry.date}</small></div>
                                         <div style="display:flex; gap:8px;">
                                           <button class="small-btn" data-copy="${entry.date}" type="button"><i class="fas fa-copy"></i> Copy</button>
                                           <button class="small-btn delete" data-delete="${entry.date}" type="button"><i class="fas fa-trash"></i> Del</button>
                                         </div>`;
                        logList.appendChild(row);
                    });
                    logList.querySelectorAll('[data-copy]').forEach(b=>{
                        b.addEventListener('click', ev=>{
                            const date = ev.currentTarget.getAttribute('data-copy');
                            const st = loadStorage();
                            if (!st.weeks) return;
                            for (const w of st.weeks) {
                                if (w.entries && w.entries[date] !== undefined) {
                                    logDateInput.value = date;
                                    logWeightInput.value = Number(w.entries[date]).toFixed(1);
                                    return;
                                }
                            }
                        });
                    });
                    logList.querySelectorAll('[data-delete]').forEach(b=>{
                        b.addEventListener('click', ev=>{
                            const date = ev.currentTarget.getAttribute('data-delete');
                            if (!confirm('Delete this entry?')) return;
                            deleteEntry(date);
                        });
                    });
                }
            } else {
                // When there's no "current" week, show a single short instruction here (no duplicates)
                logList.innerHTML = '<div style="color:#a0aec0">New week starts after 7 days from your first log — log again after that to start the next week.</div>';
            }
        }

        /* --- Copy medians into calculator fields --- */
        copyCurrToCalcBtn.addEventListener('click', ()=>{
            const storage = loadStorage();
            let currIdx = -1;
            const today = (function(){ const t = new Date(); return new Date(Date.UTC(t.getFullYear(), t.getMonth(), t.getDate())); })();
            for (let i=0;i<storage.weeks.length;i++) {
                const s = parseYMDToUTC(storage.weeks[i].start);
                const e = addDaysUTC(s,6);
                if (today.getTime() >= s.getTime() && today.getTime() <= e.getTime()) { currIdx = i; break; }
            }
            if (currIdx === -1) { alert('No active current 7-day block available.'); return; }
            const wk = storage.weeks[currIdx];
            const med = (wk.median !== undefined && wk.median !== null) ? Number(wk.median) : computeMedian(Object.values(wk.entries || {}).map(Number));
            if (med === null) { alert('No median yet'); return; }
            document.getElementById('curr_weight').value = med.toFixed(1);
            tabCalculator.click();
        });

        copyPrevToCalcBtn.addEventListener('click', ()=>{
            const storage = loadStorage();
            const today = (function(){ const t = new Date(); return new Date(Date.UTC(t.getFullYear(), t.getMonth(), t.getDate())); })();
            let lastFinished = -1;
            for (let i=0;i<storage.weeks.length;i++) {
                const s = parseYMDToUTC(storage.weeks[i].start);
                const e = addDaysUTC(s,6);
                if (e.getTime() < today.getTime()) lastFinished = i;
            }
            if (lastFinished === -1) { alert('No previous finished week available'); return; }
            const wk = storage.weeks[lastFinished];
            const med = (wk.median !== undefined && wk.median !== null) ? Number(wk.median) : computeMedian(Object.values(wk.entries || {}).map(Number));
            if (med === null) { alert('No median yet'); return; }
            // Do NOT paste into the Goal Weight when user is in Maintenance mode.
            if (goalSelect && goalSelect.value === 'maintenance') {
                alert("You're in Maintenance mode — previous-week median will not be pasted into the Goal Weight. Switch goal type or paste manually if needed.");
                return;
            }
            // otherwise paste into previous-week field as intended
            document.getElementById('prev_weight').value = med.toFixed(1);
            tabCalculator.click();
        });

        /* --- Calculator logic preserved --- */
        function toggleGoalField() {
            const goal = goalSelect.value;
            const goalField = document.getElementById('goalField');
            goalField.style.display = (goal === 'maintenance') ? 'none' : 'block';
            const prevLabel = document.querySelector('label[for="prev_weight"]');
            if (prevLabel) {
                const prevInput = document.getElementById('prev_weight');
                const currInput = document.getElementById('curr_weight');
                if (goal === 'maintenance') {
                    prevLabel.innerHTML = '<i class="fas fa-weight-scale"></i> Goal Maintenance Weight (kg):';
                    if (prevInput) prevInput.placeholder = 'e.g., 73.5';
                    if (currInput) currInput.placeholder = 'e.g., 74.0';
                } else {
                    prevLabel.innerHTML = '<i class="fas fa-weight-scale"></i> Previous Weekly Median Weight (kg):';
                    if (prevInput) prevInput.placeholder = 'e.g., 75.5';
                    if (currInput) currInput.placeholder = 'e.g., 74.8';
                }
            }
        }
        function isElementFullyVisible(el, headerHeight = 0) {
            const rect = el.getBoundingClientRect();
            return (rect.top >= headerHeight) && (rect.bottom <= window.innerHeight);
        }
        function updateCalorieDisclaimer(newCalories) {
            if (typeof newCalories !== 'number' || isNaN(newCalories)) { calorieDisclaimer.style.display = 'none'; return; }
            calorieDisclaimer.style.display = newCalories < MIN_SAFE_CALORIES ? 'block' : 'none';
        }
        function displayResultsFromRaw(caloriesCurrent, rawNewCalories) {
            const new_calories = Math.max(0, rawNewCalories);
            const displayedAdjustment = new_calories - caloriesCurrent;
            const sign = displayedAdjustment >= 0 ? '+' : '';
            adjustmentEl.textContent = `${sign}${Math.abs(displayedAdjustment).toFixed(0)} calories`;
            adjustmentEl.className = displayedAdjustment >= 0 ? 'result-value positive' : 'result-value negative';
            currentCaloriesEl.textContent = `${caloriesCurrent.toFixed(0)} calories`;
            newCaloriesEl.textContent = `${new_calories.toFixed(0)} calories`;
            const action = displayedAdjustment >= 0 ? `INCREASE your daily intake by ${Math.abs(displayedAdjustment).toFixed(0)} calories` : `DECREASE your daily intake by ${Math.abs(displayedAdjustment).toFixed(0)} calories`;
            actionText.textContent = action;
            actionBox.className = displayedAdjustment >= 0 ? 'action-box increase-action' : 'action-box decrease-action';
            actionBox.style.display = 'block';
            updateCalorieDisclaimer(new_calories);
        }
        function applyMaintenanceRateAndUpdate(currentCalories, goalWeight, currWeight) {
            const inputVal = parseFloat(maintenanceRateInput.value);
            if (isNaN(inputVal)) { alert('Please enter a valid weekly rate (kg/week).'); return; }
            const rate = inputVal;
            const rawAdjustmentKcal = rate * DAILY_FACTOR;
            const rawNewCalories = currentCalories + rawAdjustmentKcal;
            maintenanceRateDesc.innerHTML = `Using <strong>${rate.toFixed(2)} kg/week</strong> → <strong>${Math.abs(rawAdjustmentKcal).toFixed(0)} kcal/day</strong> ${rate >= 0 ? 'surplus' : 'deficit'} to move toward ${goalWeight.toFixed(1)} kg.`;
            displayResultsFromRaw(currentCalories, rawNewCalories);
        }
        function calculate() {
            try {
                const goal = goalSelect.value;
                const prev_weight_raw = document.getElementById('prev_weight').value;
                const prev_weight = parseFloat(prev_weight_raw);
                const curr_weight = parseFloat(document.getElementById('curr_weight').value);
                const calories = parseFloat(document.getElementById('calories').value);
                if (!goal) throw "Please select a goal type";
                if (isNaN(curr_weight)) throw "Please enter current weight";
                if (isNaN(calories)) throw "Please enter current calories";
                let rawNewCalories = calories;
                if (goal !== 'maintenance') {
                    if (isNaN(prev_weight)) throw "Please enter previous weight";
                    const wgRaw = document.getElementById('weekly_goal').value;
                    if (wgRaw === '' || isNaN(parseFloat(wgRaw))) throw "Please enter weekly goal amount";
                    const weekly_goal = parseFloat(wgRaw);
                    let rawAdjustmentKcal = 0;
                    if (goal === 'loss') {
                        const actual_change = prev_weight - curr_weight;
                        rawAdjustmentKcal = (actual_change - weekly_goal) * DAILY_FACTOR;
                    } else if (goal === 'gain') {
                        const actual_change = curr_weight - prev_weight;
                        rawAdjustmentKcal = -1 * (actual_change - weekly_goal) * DAILY_FACTOR;
                    }
                    rawNewCalories = calories + rawAdjustmentKcal;
                    displayResultsFromRaw(calories, rawNewCalories);
                    maintenanceRateSection.style.display = 'none';
                } else {
                    if (isNaN(prev_weight)) throw "Please enter a goal maintenance weight";
                    const goalWeight = prev_weight;
                    const diff = goalWeight - curr_weight;
                    const absDiff = Math.abs(diff);
                    const NEAR_THRESHOLD = 0.05;
                    if (absDiff <= NEAR_THRESHOLD) {
                        rawNewCalories = calories;
                        maintenanceRateSection.style.display = 'none';
                        displayResultsFromRaw(calories, rawNewCalories);
                    } else {
                        const DEFAULT_RATE_MAG = 0.25;
                        const defaultRate = (absDiff < DEFAULT_RATE_MAG) ? diff : Math.sign(diff) * DEFAULT_RATE_MAG;
                        maintenanceRateSection.style.display = 'block';
                        maintenanceRateInput.value = defaultRate.toFixed(2);
                        const rawAdjustmentKcal = defaultRate * DAILY_FACTOR;
                        rawNewCalories = calories + rawAdjustmentKcal;
                        maintenanceRateDesc.innerHTML = `Default: <strong>${defaultRate.toFixed(2)} kg/week</strong> → <strong>${Math.abs(rawAdjustmentKcal).toFixed(0)} kcal/day</strong>. Adjust below and press Apply to update the numbers.`;
                        displayResultsFromRaw(calories, rawNewCalories);
                    }
                }
                resultsSection.style.display = 'block';
                const headerEl = document.querySelector('.logo-header');
                const headerHeight = headerEl ? headerEl.offsetHeight : 0;
                const rect = resultsSection.getBoundingClientRect();
                if (!isElementFullyVisible(resultsSection, headerHeight)) {
                    const gap = 12;
                    const targetScroll = window.scrollY + rect.top - headerHeight - gap;
                    window.scrollTo({ top: Math.max(0, targetScroll), behavior: 'smooth' });
                }
            } catch (err) { alert(err); }
        }
        function resetForm() {
            goalSelect.value = "";
            document.getElementById('prev_weight').value = '';
            document.getElementById('curr_weight').value = '';
            document.getElementById('weekly_goal').value = '';
            document.getElementById('calories').value = '';
            resultsSection.style.display = 'none';
            actionBox.style.display = 'none';
            maintenanceRateSection.style.display = 'none';
            calorieDisclaimer.style.display = 'none';
            toggleGoalField();
        }
        applyRateBtn.addEventListener('click', function() {
            if (maintenanceRateSection.style.display !== 'block') { alert('Maintenance rate not available. Calculate first with Maintenance selected.'); return; }
            if (goalSelect.value !== 'maintenance') return;
            const goalWeight = parseFloat(document.getElementById('prev_weight').value);
            const currWeight = parseFloat(document.getElementById('curr_weight').value);
            const currentCalories = parseFloat(document.getElementById('calories').value);
            if (isNaN(goalWeight) || isNaN(currWeight) || isNaN(currentCalories)) { alert('Please ensure Goal Weight, Current Weight and Current Calories are set before applying the rate.'); return; }
            applyMaintenanceRateAndUpdate(currentCalories, goalWeight, currWeight);
        });
        calculateBtn.addEventListener('click', calculate);
        resetBtn.addEventListener('click', resetForm);
        toggleGoalField();

        /* --- Tab handlers / log handlers --- */
        addLogBtn.addEventListener('click', ()=> {
            addOrUpdateEntry(logDateInput.value, parseFloat(logWeightInput.value));
        });
        clearWeekBtn.addEventListener('click', ()=> {
            const storage = loadStorage();
            let curIdx = -1;
            const today = (function(){ const t = new Date(); return new Date(Date.UTC(t.getFullYear(), t.getMonth(), t.getDate())); })();
            for (let i=0;i<storage.weeks.length;i++) {
                const s = parseYMDToUTC(storage.weeks[i].start);
                const e = addDaysUTC(s,6);
                if (today.getTime() >= s.getTime() && today.getTime() <= e.getTime()) { curIdx = i; break; }
            }
            if (curIdx === -1) { alert('No active week to clear.'); return; }
            if (!confirm('Clear all entries for the active 7-day block?')) return;
            storage.weeks.splice(curIdx,1);
            saveStorage(storage);
            renderWeekData();
        });

        // Tab switching logic
        function activateTab(tabId) {
            // Hide all tabs
            calculatorTab.style.display = 'none';
            weightLogTab.style.display = 'none';
            infoTab.style.display = 'none';
            
            // Deactivate all tab buttons
            tabCalculator.classList.remove('active');
            tabWeightLog.classList.remove('active');
            tabInfo.classList.remove('active');
            tabCalculator.setAttribute('aria-selected', 'false');
            tabWeightLog.setAttribute('aria-selected', 'false');
            tabInfo.setAttribute('aria-selected', 'false');
            
            // Show selected tab and activate its button
            document.getElementById(tabId).style.display = '';
            const tabButton = document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1));
            tabButton.classList.add('active');
            tabButton.setAttribute('aria-selected', 'true');
            
            // Special handling for weight log
            if (tabId === 'weightLogTab') {
                renderWeekData();
            }
        }

        tabCalculator.addEventListener('click', () => activateTab('calculatorTab'));
        tabWeightLog.addEventListener('click', () => activateTab('weightLogTab'));
        tabInfo.addEventListener('click', () => activateTab('infoTab'));

        /* initialization */
        (function init() {
            const today = (function(){ const t = new Date(); return new Date(Date.UTC(t.getFullYear(), t.getMonth(), t.getDate())); })();
            const ymd = formatUTCToYMD(today);
            if (!logDateInput.value) logDateInput.value = ymd;
            renderWeekData();
        })();
        window.addEventListener('visibilitychange', ()=> {
            if (document.visibilityState === 'visible') renderWeekData();
        });
    </script>
</body>
</html>
